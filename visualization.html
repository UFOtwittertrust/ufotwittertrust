<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Network - Twitter Trust System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Styles specific to this visualization */
        #enhanced-network-viz {
            width: 100%;
            height: 75vh; /* Adjust height as needed */
            background: #f8f9fa; /* Light background for the viz area */
            border-radius: 4px;
        }
        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        text {
            font-family: sans-serif;
            font-size: 10px;
            pointer-events: none;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            z-index: 10; /* Ensure tooltip is on top */
        }
        .legend {
            font-size: 0.85rem;
        }
        .legend .marker {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Twitter Trust System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Rankings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="network.html">Network</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="how-it-works.html">How It Works</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="network-temporal-twitter.html">Temporal Network (Twitter)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="network-static-twitter.html">Static Network (Twitter)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="enhanced_network.html">Enhanced Network</a>
                    </li>
                    <!-- Add link to this page here later -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
         <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Enhanced Trust Network (LLM Analysis)</h2>
                        <small class="text-muted">Network generated by analyzing conversation threads and timelines with an LLM. Nodes sized by followers, colored by community.</small>
                    </div>
                    <div class="card-body p-0">
                        <div id="enhanced-network-viz">
                            <svg width="100%" height="100%"></svg> <!-- SVG container -->
                        </div>
                    </div>
                     <div class="card-footer legend">
                        <div id="community-legend-container">
                             <!-- Legend will be populated by JS -->
                        </div>
                        <div><small class="text-muted">Hover over nodes for details. Drag nodes to rearrange.</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tooltip"></div> <!-- Tooltip div -->

    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>Twitter Trust System - An experimental reputation system for Twitter users.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="js/data_twitter_enhanced.js"></script>
    <script>
        const data = typeof enhancedTrustData !== 'undefined' ? enhancedTrustData : {nodes: [], links: []}; // Use loaded data or fallback

        const vizContainer = d3.select("#enhanced-network-viz");
        const svg = vizContainer.select("svg");
        const width = vizContainer.node().getBoundingClientRect().width;
        const height = vizContainer.node().getBoundingClientRect().height;

        // Adjust viewBox if needed, or let width/height attributes handle it
        // svg.attr("viewBox", [0, 0, width, height]);

        const tooltip = d3.select(".tooltip");

        // Create a color scale for communities
        const uniqueCommunities = [...new Set(data.nodes.map(d => d.community))].sort((a,b) => a - b);
        const color = d3.scaleOrdinal(d3.schemeCategory10).domain(uniqueCommunities);

        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links).id(d => d.id).distance(120)) // Adjust distance
            .force("charge", d3.forceManyBody().strength(-250)) // Adjust strength
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("x", d3.forceX(width / 2).strength(0.05)) // Gentle pull towards center X
            .force("y", d3.forceY(height / 2).strength(0.05)); // Gentle pull towards center Y

        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(data.links)
            .enter().append("line")
            .attr("stroke-width", d => Math.sqrt(Math.max(0.5, (d.trust - TRUST_THRESHOLD || 0) / 10 + 1))) // Use TRUST_THRESHOLD from python script (default 50)
            .attr("stroke-opacity", d => Math.max(0.1, (d.trust || 0) / 100)) // Use trust for opacity
            .attr("stroke", d => (d.trust || 50) > 50 ? "green" : "red"); // Color based on trust > 50


        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(data.nodes)
            .enter().append("g");

        const circles = node.append("circle")
            .attr("r", d => 5 + Math.sqrt(d.followers ? d.followers / 5000 : 1)) // Adjust follower scaling
            .attr("fill", d => color(d.community))
            .call(drag(simulation));

        const labels = node.append("text")
            .text(d => '@' + d.screen_name)
            .attr('x', 8)
            .attr('y', 3);

        // Precompute linked nodes for faster hover lookup
        let linkedByIndex = {};
        data.links.forEach(d => {
             // Use the node objects if forceLink provides them, otherwise use IDs
            const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
            const targetId = typeof d.target === 'object' ? d.target.id : d.target;
            linkedByIndex[`${sourceId},${targetId}`] = 1;
        });

        function isConnected(a, b) {
            return linkedByIndex[`${a.id},${b.id}`] || linkedByIndex[`${b.id},${a.id}`] || a.id === b.id;
        }


        node.on("mouseover", function(event, d) {
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            tooltip.html(
                `<strong>@${d.screen_name}</strong> (${d.name || 'N/A'})<br/>` +
                `Followers: ${d.followers || 0}<br/>` +
                `Community: ${d.community}<br/>` +
                `Score: ${d.score ? d.score.toFixed(2) : 'N/A'}` // Node score (avg incoming trust)
            )
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");

            // Highlight connections
            link.style('stroke-opacity', l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                return (sourceId === d.id || targetId === d.id) ? 1 : 0.1;
             });
            link.style('stroke', l => {
                 const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                 const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                 return (sourceId === d.id || targetId === d.id) ? ( (l.trust||50)>50 ? 'darkgreen' : 'darkred') : ( (l.trust||50)>50 ? '#90ee90' : '#ffcccb'); // Highlighted vs normal color
            });
            circles.style('opacity', n => (isConnected(d,n)) ? 1 : 0.3);
            labels.style('opacity', n => (isConnected(d,n)) ? 1 : 0.3);
        })
        .on("mouseout", function(event, d) {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
            // Reset styles
            link.style('stroke-opacity', l => Math.max(0.1, (l.trust || 0) / 100));
            link.style('stroke', l => (l.trust || 50) > 50 ? "green" : "red");
            circles.style('opacity', 1);
            labels.style('opacity', 1);
        });

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // Add Community Legend
        const legendContainer = d3.select("#community-legend-container");
        legendContainer.selectAll(".legend-item")
            .data(uniqueCommunities)
            .enter().append("span")
            .attr("class", "legend-item me-3")
            .html(d => `<span class="marker" style="background-color: ${color(d)};"></span> Community ${d}`);


    </script>
</body>
</html> 